<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiple Choice</title>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
    <link
      rel="stylesheet"
      href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/static/styles.css" />
    <script type="text/javascript" src="{{ url_for('static', filename = 'quiz.js') }}"></script>
    <script>
      var correctSVG =
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="green" style="float:right; margin-top: 2px;" viewBox="0 0 24 24"><path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"/></svg>';
      var wrongSVG =
        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(182, 24, 24)" style="float:right; margin-top: 2px;" viewBox="0 0 24 24"><path d="M23 20.168l-8.185-8.187 8.185-8.174-2.832-2.807-8.182 8.179-8.176-8.179-2.81 2.81 8.186 8.196-8.186 8.184 2.81 2.81 8.203-8.192 8.18 8.192z"/></svg>';

      function save_answer(answer) {
        var answerData = {
          quizId: "{{ quiz.id }}",
          answer: answer
        };

        $.ajax({
          url: "/save_answer",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(answerData),
          success: function (response) {
            console.log("Results saved successfully");
          },
          error: function () {
            console.log("Error saving results");
          },
        });
      }

      function next_page() {
        if ("{{quiz.next}}" === "end") {
          window.location.href = "/quiz/results/1";
        } else {
          window.location.href = "/quiz/{{quiz.next}}";
        }
      }

      function back_page(){
        window.location.href = '/quiz/{{quiz.id-1}}'
      }

      $(document).ready(function () {
        let isAnswered = {{ is_answered | tojson}};
        let correctAnswer = "{{ quiz.answer }}";
        let userAnswer = "{{ user_answer }}";

        function updateChoiceDisplay() {
          $("#quiz-choices").toggle(!isAnswered);
          $("#quiz-choices-disabled").toggle(isAnswered);
          $("#submit").toggle(!isAnswered);
          $("#next").toggle(isAnswered);
        }

        function applyAnswerStyles() {
          $("#quiz-choices-disabled label").each(function () {
            let choiceText = $(this).text().trim();
            if (choiceText === correctAnswer) {
              $(this).addClass("correct-answer").append(correctSVG);
            }
            if (choiceText === userAnswer && userAnswer !== correctAnswer) {
              $(this).addClass("incorrect-answer").append(wrongSVG);
            }
          });
        }

        // Set initial display based on whether the quiz has been answered
        updateChoiceDisplay();
        if (isAnswered) {
          applyAnswerStyles();
        }

        // Handle submit action
        $("#submit").click(function () {
          userAnswer = $('input[name="option"]:checked').val();
          isAnswered = true;

          updateChoiceDisplay();
          applyAnswerStyles();
          save_answer(userAnswer);
        });

        $("#next").click(function () {
          next_page();
        });

        $("#back").click(function () {
          back_page();
        });
      });
    </script>
  </head>

  <body>
    {% include 'navbar.html' %}
    <div
      class="container flex-column mt-3"
      style="font-family: 'Raleway', sans-serif; color: black;">

      <div class="row">
        
        <div class="col"></div>
        <div class="col-md-7">

          <div class="progress mt-3 mb-3">
            <div class="progress-bar progress-bar-striped" role="progressbar" 
                 style="width: {{ (quiz.id / 10 * 100) | round(0) }}%" 
                 aria-valuenow="{{ quiz.id }}" aria-valuemin="0" aria-valuemax="10">
            </div>
        </div>

          <div class="quiz-box">
          <h5>{{quiz.id}}. {{quiz.question}}</h5>

          {% if quiz.image %}
          <div class="d-flex justify-content-center">
            <img src="{{ quiz.image }}" class="img-fluid quiz-image" />
        </div>          
        {% endif %}

          <ul class="quiz-list" id="quiz-choices">
            {% for choice in quiz.choices %}
            <li>
              <input
                class="answer"
                type="radio"
                name="option"
                id="{{ choice }}"
                value="{{ choice }}"
              />
              <label class="border p-3" for="{{ choice }}">{{ choice }}</label>
            </li>
            {% endfor %}
          </ul>
          

          <ul class="quiz-list" id="quiz-choices-disabled">
            {% for choice in quiz.choices %}
            <li>
              <label class="border p-3" for="{{ choice }}">{{ choice }}</label>
            </li>
            {% endfor %}
          </ul>

        </div>
          <div class="row mt-4">
            {% if quiz.id-1 > 0 %}
            <div class="col">
                <button id="back" class="custombutton bluebutton">Back</button>
            </div>
            {% endif %}
            <div class="col">
              <button id="submit" class="custombutton greenbutton">
                Submit
              </button>
              <button id="next" class="custombutton bluebutton">Next</button>
            </div>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
  </body>
</html>
